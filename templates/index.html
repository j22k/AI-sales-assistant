<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two-Column Layout with Video and Audio Recording</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container my-5">
        <div class="row">
            <!-- Video Column -->
            <div class="col-md-6">
                <video id="videoPlayer" width="100%" muted>
                    <source src="{{ url_for('static', filename='salesman.mp4') }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
            <!-- Text and Input Column -->
            <div class="col-md-6">
                <div class="p-3 bg-light">
                    <p id="textDisplay" class="form-control bg-white border" aria-label="Text content">Your text will
                        appear here after processing.</p>

                    <!-- Text Field and Record Button -->
                    <div class="input-group mt-3">

                        <button id="recordButton" class="btn btn-danger" type="button">Record</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

    <!-- JavaScript for Audio Recording and Video Control -->
    <script>
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];
        const recordButton = document.getElementById('recordButton');
        const videoPlayer = document.getElementById('videoPlayer');

        // Access the microphone and set up the MediaRecorder
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);

                    // Play the video when audio starts
                    audio.onplay = () => {
                        videoPlayer.play();
                    };

                    // Stop the video when audio stops
                    audio.onended = () => {
                        videoPlayer.pause();
                        videoPlayer.currentTime = 0; // Reset video to start
                    };

                    // Play the recorded audio
                    //audio.play();

                    // Create FormData object to send audio to the server
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'recording.wav');

                    // Send the audio file to the server
                    fetch('/convert', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log(data);
                            const text = "hello world";

                            // Create a new SpeechSynthesisUtterance object
                            const utterance = new SpeechSynthesisUtterance(text);

                            // Set the language (optional)
                            utterance.lang = 'en-US';

                            // Set the voice (optional)
                            const voices = window.speechSynthesis.getVoices();
                            utterance.voice = voices.find(voice => voice.name === 'Google US English') || voices[0];

                            // Set pitch and rate (optional)
                            utterance.pitch = 1;
                            utterance.rate = 1;

                            // Speak the text
                            window.speechSynthesis.speak(utterance);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });

                    // Clear the audio chunks array for the next recording
                    audioChunks = [];
                };
            });

        // Toggle recording state on button click
        recordButton.addEventListener('click', () => {
            if (isRecording) {
                mediaRecorder.stop();
                recordButton.textContent = 'Record';
                recordButton.classList.replace('btn-danger', 'btn-primary');
            } else {
                mediaRecorder.start();
                recordButton.textContent = 'Stop Recording';
                recordButton.classList.replace('btn-primary', 'btn-danger');
            }
            isRecording = !isRecording;
        });
    </script>
</body>

</html>